<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Article</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
  line-height: 1.7;
}
img {
  max-width: 100%;
  border-radius: 8px;
  margin: 15px 0;
}
.section-title {
  margin-top: 40px;
  font-size: 1.3em;
  font-weight: bold;
  border-bottom: 2px solid #ddd;
  padding-bottom: 6px;
}
ul.article-list {
  list-style: none;
  padding: 0;
  margin: 10px 0 30px 0;
}
li.article-item {
  margin-bottom: 8px;
}
li.article-item a {
  text-decoration: none;
  color: #000;
}
hr {
  margin: 50px 0;
  border: 1px dashed #ccc;
}
</style>
</head>

<body>

<div id="article">Loading articleâ€¦</div>
<div id="extra-articles"></div>

<script>
const params = new URLSearchParams(window.location.search);
let mainId = params.get("id");
let displayedMainArticles = new Set(); // Track full articles already shown as main
let displayedRelatedArticles = new Set(); // Track articles already shown in blocks

async function fetchArticle(id) {
  const res = await fetch(`https://viral-news-backend-3.onrender.com/articles/${id}`);
  return await res.json();
}

async function fetchAllArticles() {
  const res = await fetch(`https://viral-news-backend-3.onrender.com/articles/`);
  return await res.json();
}

function renderArticle(article) {
  displayedMainArticles.add(article.id);

  return `
    <h1>${article.title}</h1>
    ${article.image_url ? `<img src="${article.image_url}">` : ""}
    ${article.content}
  `;
}

// Pick articles for a section, excluding any main articles already shown
function pickArticles(list, category, count = 3) {
  let filtered = list.filter(a => !displayedMainArticles.has(a.id) && !displayedRelatedArticles.has(a.id) && a.category === category);
  let picked = filtered.slice(0, count);

  // Fill from other categories if fewer than count
  if (picked.length < count) {
    const remaining = list.filter(a => !displayedMainArticles.has(a.id) && !displayedRelatedArticles.has(a.id) && !picked.includes(a));
    picked = picked.concat(remaining.slice(0, count - picked.length));
  }

  // Mark picked articles as displayed in blocks
  picked.forEach(a => displayedRelatedArticles.add(a.id));
  return picked;
}

function renderArticleList(title, articles) {
  if (!articles || articles.length === 0) return "";

  const items = articles.map(a => `<li class="article-item"><a href="?id=${a.id}">${a.title}</a></li>`).join("\n");

  return `
    <div class="section-title">${title}</div>
    <ul class="article-list">${items}</ul>
  `;
}

async function loadMainAndExtras(articleId) {
  const allArticles = await fetchAllArticles();
  let mainArticle = await fetchArticle(articleId);
  if (!mainArticle || !mainArticle.title) {
    document.getElementById("article").innerHTML = "Article not found.";
    return;
  }

  document.getElementById("article").insertAdjacentHTML('beforeend', renderArticle(mainArticle));

  const relatedArticles = pickArticles(allArticles, mainArticle.category, 3);
  const mostReadArticles = pickArticles(allArticles, "Most Read", 3);
  const opinionArticles = pickArticles(allArticles, "Opinion", 3);

  const extraHTML = `
    ${renderArticleList("Related", relatedArticles)}
    ${renderArticleList("Most Read", mostReadArticles)}
    ${renderArticleList("Opinion", opinionArticles)}
  `;
  document.getElementById("extra-articles").insertAdjacentHTML('beforeend', extraHTML);
}

// Infinite scroll: load next main article automatically
async function setupInfiniteScroll() {
  window.addEventListener('scroll', async () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 10) {
      const allArticles = await fetchAllArticles();
      const nextArticle = allArticles.find(a => !displayedMainArticles.has(a.id));
      if (nextArticle) {
        await loadMainAndExtras(nextArticle.id);
      }
    }
  });
}

// Initial load
if (!mainId) {
  document.getElementById("article").innerHTML = "Article not found.";
} else {
  loadMainAndExtras(mainId);
  setupInfiniteScroll();
}
</script>
</body>
</html>
