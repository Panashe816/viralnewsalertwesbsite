<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Article</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
  line-height: 1.7;
}
img {
  max-width: 100%;
  border-radius: 8px;
  margin: 15px 0;
}
.section-title {
  margin-top: 40px;
  font-size: 1.3em;
  font-weight: bold;
  border-bottom: 2px solid #ddd;
  padding-bottom: 6px;
}
ul.article-list {
  list-style: none;
  padding: 0;
  margin: 10px 0 30px 0;
}
li.article-item {
  margin-bottom: 8px;
}
li.article-item a {
  text-decoration: none;
  color: #000;
}
</style>
</head>

<body>

<div id="article">Loading article…</div>
<div id="extra-articles"></div>

<script>
const params = new URLSearchParams(window.location.search);
let mainId = params.get("id");
let loadedArticles = new Set(); // Track IDs we’ve displayed

async function fetchArticle(id) {
  const res = await fetch(`https://viral-news-backend-3.onrender.com/articles/${id}`);
  return await res.json();
}

async function fetchAllArticles() {
  const res = await fetch(`https://viral-news-backend-3.onrender.com/articles/`);
  return await res.json();
}

function renderArticle(article) {
  document.title = article.title;
  loadedArticles.add(article.id);

  return `
    <h1>${article.title}</h1>
    ${article.image_url ? `<img src="${article.image_url}">` : ""}
    ${article.content}
  `;
}

function pickArticles(list, category, excludeIds, count = 3) {
  // First, get articles from the same category
  let filtered = list.filter(a => a.category === category && !excludeIds.has(a.id));
  let picked = filtered.slice(0, count);

  // If not enough, fill from other categories
  if (picked.length < count) {
    const remaining = list.filter(a => !excludeIds.has(a.id) && !picked.includes(a));
    picked = picked.concat(remaining.slice(0, count - picked.length));
  }

  return picked;
}

function renderArticleList(title, articles) {
  if (!articles || articles.length === 0) return "";

  const items = articles.map(a => `<li class="article-item"><a href="?id=${a.id}">${a.title}</a></li>`).join("\n");

  return `
    <div class="section-title">${title}</div>
    <ul class="article-list">${items}</ul>
  `;
}

async function loadMainAndExtras() {
  const allArticles = await fetchAllArticles();
  if (!mainId) {
    document.getElementById("article").innerHTML = "Article not found.";
    return;
  }

  let mainArticle = await fetchArticle(mainId);
  if (!mainArticle || !mainArticle.title) {
    document.getElementById("article").innerHTML = "Article not found.";
    return;
  }

  document.getElementById("article").innerHTML = renderArticle(mainArticle);

  const relatedArticles = pickArticles(allArticles, mainArticle.category, loadedArticles, 3);
  const mostReadArticles = pickArticles(allArticles, "Most Read", loadedArticles, 3);
  const opinionArticles = pickArticles(allArticles, "Opinion", loadedArticles, 3);

  const extraHTML = `
    ${renderArticleList("Related", relatedArticles)}
    ${renderArticleList("Most Read", mostReadArticles)}
    ${renderArticleList("Opinion", opinionArticles)}
  `;
  document.getElementById("extra-articles").innerHTML = extraHTML;
}

// Infinite scroll: load next main article automatically
async function setupInfiniteScroll() {
  window.addEventListener('scroll', async () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 10) {
      // Pick next article not loaded yet
      const allArticles = await fetchAllArticles();
      const nextArticle = allArticles.find(a => !loadedArticles.has(a.id));
      if (nextArticle) {
        mainId = nextArticle.id;
        const container = document.getElementById("article");
        container.insertAdjacentHTML('beforeend', '<hr>' + renderArticle(nextArticle));

        const relatedArticles = pickArticles(allArticles, nextArticle.category, loadedArticles, 3);
        const mostReadArticles = pickArticles(allArticles, "Most Read", loadedArticles, 3);
        const opinionArticles = pickArticles(allArticles, "Opinion", loadedArticles, 3);

        const extraHTML = `
          ${renderArticleList("Related", relatedArticles)}
          ${renderArticleList("Most Read", mostReadArticles)}
          ${renderArticleList("Opinion", opinionArticles)}
        `;
        document.getElementById("extra-articles").insertAdjacentHTML('beforeend', extraHTML);
      }
    }
  });
}

loadMainAndExtras();
setupInfiniteScroll();

</script>
</body>
</html>
