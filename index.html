<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VIRAL NEWS</title>
<meta name="description" content="Viral News – Latest headlines from all categories" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5368831813847678"
     crossorigin="anonymous"></script>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#081737">

<style>
  :root{
    --bg:#0a1d3f;
    --bg2:#081737;
    --panel:#0f264f;
    --line:#334a7a;
    --text:#ffffff;
    --muted:#cfd8ea;
    --accent:#ffcc00;
    --danger:#ff6b6b;
    --shadow: 0 10px 24px rgba(0,0,0,.25);
    --radius: 12px;
  }

  *{ box-sizing: border-box; }
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  /* ===== Top Header (Brand + Category Bar) ===== */
  header{
    background: var(--bg2);
    position: sticky;
    top:0;
    z-index:1000;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }

  .top-row{
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 12px 18px 10px;
  }
  .brand{
    margin:0;
    font-size: 22px;
    letter-spacing: .7px;
    font-weight: 800;
  }

  .catbar{
    display:flex;
    gap: 10px;
    overflow-x: auto;
    padding: 10px 12px 12px;
    border-top: 1px solid rgba(255,255,255,.06);
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  .catbar::-webkit-scrollbar{ height: 8px; }
  .catbar::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.18);
    border-radius: 999px;
  }

  .catbtn{
    scroll-snap-align: start;
    flex: 0 0 auto;
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color:#fff;
    text-decoration:none;
    font-size: 13px;
    font-weight: 800;
    user-select:none;
    white-space: nowrap;
  }
  .catbtn:hover{ border-color: rgba(255,204,0,.35); color: var(--accent); }
  .catbtn.active{
    background: rgba(255,204,0,.16);
    border-color: rgba(255,204,0,.30);
    color: var(--accent);
  }

  #news-container{
    max-width: 1120px;
    margin: 18px auto 70px;
    padding: 0 16px;
  }

  .section-title{
    display:flex;
    align-items:center;
    gap:10px;
    margin: 26px 0 14px;
  }
  .section-title .bar{
    width:4px; height:18px;
    background: var(--accent);
    border-radius: 10px;
  }
  .section-title h2{
    margin:0;
    font-size: 18px;
    letter-spacing: .3px;
  }
  .section-title .viewall{
    margin-left:auto;
    color: var(--accent);
    font-size: 13px;
    text-decoration:none;
  }
  .section-title .viewall:hover{ text-decoration: underline; }

  .card{
    background: var(--panel);
    border-radius: var(--radius);
    overflow:hidden;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,.06);
  }

  /* Back to Home */
  .back-home{
    display:inline-block;
    margin: 10px 0 8px;
    color: var(--accent);
    text-decoration:none;
    font-weight: 800;
    font-size: 14px;
  }
  .back-home:hover{ text-decoration: underline; }

  /* HERO */
  .hero-grid{
    display:grid;
    grid-template-columns: 1.35fr .65fr;
    gap: 14px;
    margin-top: 12px;
  }
  .hero-main{ display:flex; flex-direction:column; }
  .hero-main .img{
    width:100%;
    aspect-ratio: 16/9;
    background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    position:relative;
    overflow:hidden;
  }
  .hero-main .img img{ width:100%; height:100%; object-fit:cover; display:block; }
  .hero-main .body{ padding: 14px 14px 12px; }

  .kicker{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom: 8px;
    color: var(--muted);
    font-size: 12px;
  }
  .chip{
    background: rgba(255,204,0,.16);
    color: var(--accent);
    border: 1px solid rgba(255,204,0,.25);
    padding: 3px 8px;
    border-radius: 999px;
    font-weight: 800;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing:.4px;
  }
  .hero-title{
    font-size: 22px;
    margin: 0 0 6px;
    line-height: 1.25;
  }
  .hero-title a{ color:#fff; text-decoration:none; }
  .hero-title a:hover{ color: var(--accent); }
  .hero-desc{
    margin: 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }

  .hero-side{
    display:flex;
    flex-direction:column;
    gap: 10px;
  }
  .side-item{
    display:grid;
    grid-template-columns: 86px 1fr;
    gap:10px;
    padding: 10px;
    background: var(--panel);
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.06);
  }
  .side-thumb{
    width:86px;
    height:64px;
    border-radius: 10px;
    overflow:hidden;
    background: rgba(255,255,255,.06);
  }
  .side-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .side-title{
    margin:0;
    font-size: 13px;
    line-height: 1.25;
    font-weight: 900;
  }
  .side-title a{ color:#fff; text-decoration:none; }
  .side-title a:hover{ color: var(--accent); }
  .meta{
    margin-top: 6px;
    font-size: 12px;
    color: var(--muted);
  }

  /* Breaking strip */
  .strip{ display:grid; grid-template-columns: 1fr; gap: 10px; }
  .strip-item{
    display:flex;
    align-items:flex-start;
    padding: 12px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
  }
  .strip-item a{
    color:#fff;
    text-decoration:none;
    font-weight: 900;
    line-height: 1.25;
  }
  .strip-item a:hover{ color: var(--accent); }
  .strip-meta{
    color: var(--muted);
    font-size: 12px;
    margin-top: 4px;
  }

  /* Category blocks */
  .cat-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  .cat-block{ display:flex; flex-direction:column; gap: 10px; }

  .lead{
    display:grid;
    grid-template-columns: 120px 1fr;
    gap: 12px;
    padding: 12px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
  }
  .lead .thumb{
    width:120px;
    height:84px;
    border-radius: 12px;
    overflow:hidden;
    background: rgba(255,255,255,.06);
  }
  .lead .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .lead h3{ margin:0; font-size: 14px; line-height: 1.25; }
  .lead h3 a{ color:#fff; text-decoration:none; font-weight: 900; }
  .lead h3 a:hover{ color: var(--accent); }

  .list{ display:flex; flex-direction:column; gap: 8px; }
  .list-row{
    display:flex;
    gap: 10px;
    align-items:center;
    padding: 10px 12px;
    background: rgba(255,255,255,.02);
    border: 1px solid rgba(255,255,255,.05);
    border-radius: 12px;
  }
  .list-row .mini{
    width:56px;
    height:42px;
    border-radius: 10px;
    background: rgba(255,255,255,.06);
    overflow:hidden;
    flex: 0 0 auto;
  }
  .list-row .mini img{ width:100%; height:100%; object-fit:cover; display:block; }
  .list-row a{
    color:#fff;
    text-decoration:none;
    font-weight: 900;
    font-size: 13px;
    line-height: 1.25;
    display:block;
  }
  .list-row a:hover{ color: var(--accent); }
  .list-row .time{
    margin-left:auto;
    color: var(--muted);
    font-size: 12px;
    flex: 0 0 auto;
  }

  /* Horizontal rail */
  .rail{
    display:flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 6px;
    scroll-snap-type: x mandatory;
  }
  .rail::-webkit-scrollbar{ height: 8px; }
  .rail::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.18);
    border-radius: 999px;
  }
  .rail-card{
    min-width: 260px;
    max-width: 260px;
    scroll-snap-align: start;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    overflow:hidden;
  }
  .rail-card .thumb{
    width:100%;
    height: 150px;
    background: rgba(255,255,255,.06);
    overflow:hidden;
  }
  .rail-card .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .rail-card .body{ padding: 10px 12px 12px; }
  .rail-card .title{ margin:0; font-size: 14px; line-height: 1.25; }
  .rail-card .title a{
    color:#fff;
    text-decoration:none;
    font-weight: 900;
  }
  .rail-card .title a:hover{ color: var(--accent); }
  .rail-card .meta{ margin-top: 8px; font-size: 12px; color: var(--muted); }

  /* Entertainment text-only block */
  .text-only{
    display:flex;
    flex-direction:column;
    gap: 10px;
  }
  .text-only .row{
    padding: 12px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
  }
  .text-only .row a{
    color:#fff;
    text-decoration:none;
    font-weight: 900;
    line-height: 1.25;
  }
  .text-only .row a:hover{ color: var(--accent); }
  .text-only .meta{ margin-top: 6px; }

  /* More for you (infinite) */
  .more-wrap{ margin-top: 10px; }
  .more-list{
    display:flex;
    flex-direction:column;
    gap: 10px;
  }
  .more-item{
    display:grid;
    grid-template-columns: 92px 1fr;
    gap: 12px;
    padding: 12px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
  }
  .more-thumb{
    width:92px;
    height:72px;
    border-radius: 12px;
    background: rgba(255,255,255,.06);
    overflow:hidden;
  }
  .more-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .more-item a{
    color:#fff;
    text-decoration:none;
    font-weight: 900;
    line-height: 1.25;
    display:block;
  }
  .more-item a:hover{ color: var(--accent); }
  .more-meta{ margin-top: 6px; color: var(--muted); font-size: 12px; }

  .load-hint{
    text-align:center;
    margin: 16px 0 0;
    color: var(--muted);
    font-size: 12px;
  }

  .error-box{
    background: #331a1a;
    border: 1px solid var(--danger);
    padding: 12px;
    border-radius: var(--radius);
  }

  @media (max-width: 980px){
    .hero-grid{ grid-template-columns: 1fr; }
    .hero-side{ flex-direction: row; flex-wrap: wrap; }
    .side-item{ grid-template-columns: 70px 1fr; flex: 1 1 280px; }
  }
  @media (max-width: 760px){
    #news-container{ padding: 0 12px; }
    .brand{ font-size: 20px; }
    .cat-grid{ grid-template-columns: 1fr; }
    .lead{ grid-template-columns: 92px 1fr; }
    .lead .thumb{ width:92px; height:70px; }
    .hero-title{ font-size: 20px; }
    .more-item{ grid-template-columns: 80px 1fr; }
    .more-thumb{ width:80px; height:62px; }
  }
  @media (max-width: 420px){
    .side-item{ grid-template-columns: 64px 1fr; }
    .side-thumb{ width:64px; height:52px; }
    .rail-card{ min-width: 220px; max-width: 220px; }
    .rail-card .thumb{ height: 130px; }
  }
</style>
</head>

<body>

<header>
  <div class="top-row">
    <h1 class="brand">VIRAL NEWS</h1>
  </div>

  <!-- Horizontal scroll category bar -->
  <nav class="catbar" id="catbar">
    <a class="catbtn active" href="#" data-cat="__home__">Home</a>
    <a class="catbtn" href="#" data-cat="breaking">Breaking</a>
    <a class="catbtn" href="#" data-cat="trending">Trending</a>
    <a class="catbtn" href="#" data-cat="top headlines">Top Headlines</a>
    <a class="catbtn" href="#" data-cat="General News">General News</a>
    <a class="catbtn" href="#" data-cat="World News">World News</a>
    <a class="catbtn" href="#" data-cat="Politics">Politics</a>
    <a class="catbtn" href="#" data-cat="Technology">Technology</a>
    <a class="catbtn" href="#" data-cat="Sports">Sports</a>
    <a class="catbtn" href="#" data-cat="Health & Fitness">Health & Fitness</a>
    <a class="catbtn" href="#" data-cat="Entertainment">Entertainment</a>
  </nav>
</header>

<div id="news-container">Loading…</div>

<script>
(function(){
  var API_BASE = "https://viral-news-backend-3.onrender.com";

  function escapeHtml(s){
    s = (s || "").toString();
    return s
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatTime(dt){
    var d = new Date(dt);
    if (isNaN(d.getTime())) return "";
    var diffMs = Date.now() - d.getTime();
    var mins = Math.floor(diffMs / 60000);
    if (mins < 1) return "now";
    if (mins < 60) return mins + "m";
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + "h";
    var days = Math.floor(hrs / 24);
    return days + "d";
  }

  function safeTime(a){ return a.published_at || a.created_at || ""; }
  function hasImage(a){ return !!((a.image_url || "").trim()); }
  function pickImage(a){
    var img = (a.image_url || "").trim();
    return img ? img : null;
  }
  function linkToArticle(a){ return "articles.html?id=" + encodeURIComponent(a.id); }

  function sectionHeader(title, viewAllCategory){
    var viewAll = viewAllCategory ? '<a class="viewall" href="#" data-viewall="' + escapeHtml(viewAllCategory) + '">View all</a>' : "";
    return '' +
      '<div class="section-title">' +
        '<div class="bar"></div>' +
        '<h2>' + escapeHtml(title) + '</h2>' +
        viewAll +
      '</div>';
  }

  function firstNonEmpty(arr){
    arr = arr || [];
    for (var i=0;i<arr.length;i++){
      var x = arr[i];
      if (x && x.id && x.title) return x;
    }
    return null;
  }

  function take(arr, n){ return (arr || []).slice(0, n); }

  function sortNewestFirst(arr){
    arr = (arr || []).slice();
    arr.sort(function(a,b){
      var da = new Date(safeTime(a)).getTime() || 0;
      var db = new Date(safeTime(b)).getTime() || 0;
      return db - da;
    });
    return arr;
  }

  function pickTopWithImages(items, count){
    items = sortNewestFirst(items || []);
    var withImg = [];
    for (var i=0;i<items.length;i++){
      if (hasImage(items[i])) withImg.push(items[i]);
      if (withImg.length >= count) break;
    }
    return withImg;
  }

  function pickFirstWithImage(items){
    items = sortNewestFirst(items || []);
    for (var i=0;i<items.length;i++){
      if (hasImage(items[i])) return items[i];
    }
    return firstNonEmpty(items);
  }

  function fetchWithTimeout(url, ms){
    return new Promise(function(resolve, reject){
      var timer = setTimeout(function(){ reject(new Error("Request timed out after " + ms + "ms")); }, ms);
      fetch(url, { cache:"no-store" })
        .then(function(res){ clearTimeout(timer); resolve(res); })
        .catch(function(err){ clearTimeout(timer); reject(err); });
    });
  }

  function showError(msg){
    var c = document.getElementById("news-container");
    c.innerHTML = '<div class="error-box">Failed to load homepage.<br><span style="color:var(--muted);font-size:12px;">' + escapeHtml(msg) + '</span></div>';
  }

  var homepageData = null;

  // More For You infinite scroll state
  var moreAll = [];
  var moreShown = 0;
  var MORE_BATCH = 12;
  var moreListEl = null;
  var moreLoadingEl = null;
  var loadingMore = false;
  var infiniteInstalled = false;

  function renderMoreBatch(){
    if (!moreListEl || loadingMore) return;
    loadingMore = true;

    var end = Math.min(moreAll.length, moreShown + MORE_BATCH);
    for (var i=moreShown;i<end;i++){
      var a = moreAll[i];
      var img = pickImage(a);
      var t = formatTime(safeTime(a));

      var div = document.createElement("div");
      div.className = "more-item";
      div.innerHTML =
        '<div class="more-thumb">' + (img ? '<img loading="lazy" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
        '<div>' +
          '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
          '<div class="more-meta">' + escapeHtml(t) + '</div>' +
        '</div>';

      moreListEl.appendChild(div);
    }

    moreShown = end;

    if (moreShown >= moreAll.length){
      moreLoadingEl.textContent = "No more articles.";
    } else {
      moreLoadingEl.textContent = "Scroll for more…";
    }

    loadingMore = false;
  }

  function installInfiniteScroll(){
    if (infiniteInstalled) return;
    infiniteInstalled = true;

    window.addEventListener("scroll", function(){
      if (!moreListEl) return;
      if (moreShown >= moreAll.length) return;

      var rect = moreListEl.getBoundingClientRect();
      if (rect.bottom <= window.innerHeight + 300){
        renderMoreBatch();
      }
    }, { passive:true });
  }

  function setActiveTab(cat){
    document.querySelectorAll(".catbtn").forEach(function(btn){
      btn.classList.remove("active");
    });
    var sel = document.querySelector('.catbtn[data-cat="' + cat.replace(/"/g,'\\"') + '"]');
    if (sel) sel.classList.add("active");
  }

  function renderBBCStyleHome(){
    setActiveTab("__home__");

    var container = document.getElementById("news-container");
    container.innerHTML = "";

    var categories = homepageData.categories || {};
    var all = homepageData.all || [];

    // ----- HERO (Top Headlines) -----
    var top = categories["top headlines"] || categories["Top Headlines"] || [];
    var heroMain = pickFirstWithImage(top) || pickFirstWithImage(all);

    var heroSideCandidates = top.filter(function(x){ return heroMain ? x.id !== heroMain.id : true; });
    heroSideCandidates = sortNewestFirst(heroSideCandidates);

    var sideWithImg = heroSideCandidates.filter(hasImage);
    var sideNoImg = heroSideCandidates.filter(function(x){ return !hasImage(x); });
    var heroSideItems = take(sideWithImg.concat(sideNoImg), 4);

    var heroWrap = document.createElement("div");
    heroWrap.innerHTML = sectionHeader("Top Headlines", "top headlines");

    var heroGrid = document.createElement("div");
    heroGrid.className = "hero-grid";

    var mainCard = document.createElement("div");
    mainCard.className = "card hero-main";

    var mainImg = heroMain ? pickImage(heroMain) : null;
    var mainTime = heroMain ? formatTime(safeTime(heroMain)) : "";

    mainCard.innerHTML =
      '<div class="img">' + (mainImg ? '<img loading="lazy" src="' + mainImg + '" alt="' + escapeHtml(heroMain.title) + '">' : '') + '</div>' +
      '<div class="body">' +
        '<div class="kicker">' +
          '<span class="chip">Top</span>' +
          '<span>' + escapeHtml(mainTime) + '</span>' +
        '</div>' +
        '<h3 class="hero-title"><a href="' + (heroMain ? linkToArticle(heroMain) : '#') + '">' + escapeHtml(heroMain ? heroMain.title : 'No headline yet') + '</a></h3>' +
        '<p class="hero-desc">' + escapeHtml(heroMain && heroMain.summary ? heroMain.summary : '') + '</p>' +
      '</div>';

    var sideCol = document.createElement("div");
    sideCol.className = "hero-side";

    if (!heroSideItems.length){
      var empty = document.createElement("div");
      empty.className = "side-item";
      empty.innerHTML = '<div class="side-thumb"></div><div><p class="side-title">No more headlines yet.</p></div>';
      sideCol.appendChild(empty);
    } else {
      heroSideItems.forEach(function(a){
        var img = pickImage(a);
        var t = formatTime(safeTime(a));
        var div = document.createElement("div");
        div.className = "side-item";
        div.innerHTML =
          '<div class="side-thumb">' + (img ? '<img loading="lazy" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
          '<div>' +
            '<p class="side-title"><a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a></p>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        sideCol.appendChild(div);
      });
    }

    heroGrid.appendChild(mainCard);
    heroGrid.appendChild(sideCol);
    heroWrap.appendChild(heroGrid);
    container.appendChild(heroWrap);

    // ----- Breaking strip -----
    var breaking = sortNewestFirst(categories["breaking"] || []);
    var breakingBlock = document.createElement("div");
    breakingBlock.innerHTML = sectionHeader("Breaking", "breaking");

    var strip = document.createElement("div");
    strip.className = "strip";

    var breakingItems = take(breaking, 6);
    if (!breakingItems.length){
      var bEmpty = document.createElement("div");
      bEmpty.className = "strip-item";
      bEmpty.innerHTML = "<div>(no items yet)</div>";
      strip.appendChild(bEmpty);
    } else {
      breakingItems.forEach(function(a){
        var row = document.createElement("div");
        row.className = "strip-item";
        row.innerHTML =
          '<div style="flex:1">' +
            '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
            '<div class="strip-meta">' + escapeHtml(formatTime(safeTime(a))) + '</div>' +
          '</div>';
        strip.appendChild(row);
      });
    }

    breakingBlock.appendChild(strip);
    container.appendChild(breakingBlock);

    // ----- Trending rail -----
    var trending = sortNewestFirst(categories["trending"] || []);
    var trendWrap = document.createElement("div");
    trendWrap.innerHTML = sectionHeader("Trending", "trending");

    var rail = document.createElement("div");
    rail.className = "rail";

    var trendItems = take(trending, 12);
    if (!trendItems.length){
      var tEmpty = document.createElement("div");
      tEmpty.className = "error-box";
      tEmpty.textContent = "(no items yet)";
      trendWrap.appendChild(tEmpty);
    } else {
      trendItems.forEach(function(a){
        var img = pickImage(a);
        var t = formatTime(safeTime(a));
        var card = document.createElement("div");
        card.className = "rail-card";
        card.innerHTML =
          '<div class="thumb">' + (img ? '<img loading="lazy" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
          '<div class="body">' +
            '<p class="title"><a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a></p>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        rail.appendChild(card);
      });
      trendWrap.appendChild(rail);
    }
    container.appendChild(trendWrap);

    // ----- Category blocks (lead + list, MUST BE IMAGE ITEMS) -----
    var blockCats = ["World News","Politics","General News","Technology","Sports"];
    var catGridWrap = document.createElement("div");
    catGridWrap.innerHTML = sectionHeader("Latest by Category");
    var catGrid = document.createElement("div");
    catGrid.className = "cat-grid";

    blockCats.forEach(function(catName){
      var items = sortNewestFirst(categories[catName] || []);
      var withImagesTop5 = pickTopWithImages(items, 5); // only with images
      var leadItem = withImagesTop5.length ? withImagesTop5[0] : null;
      var rest = withImagesTop5.length > 1 ? withImagesTop5.slice(1) : [];

      var block = document.createElement("div");
      block.className = "cat-block";

      var sub = document.createElement("div");
      sub.innerHTML = sectionHeader(catName, catName);
      block.appendChild(sub);

      if (leadItem){
        var img = pickImage(leadItem);
        var t = formatTime(safeTime(leadItem));
        var lead = document.createElement("div");
        lead.className = "lead";
        lead.innerHTML =
          '<div class="thumb">' + (img ? '<img loading="lazy" src="' + img + '" alt="' + escapeHtml(leadItem.title) + '">' : '') + '</div>' +
          '<div>' +
            '<h3><a href="' + linkToArticle(leadItem) + '">' + escapeHtml(leadItem.title) + '</a></h3>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        block.appendChild(lead);
      } else {
        var emptyLead = document.createElement("div");
        emptyLead.className = "lead";
        emptyLead.innerHTML = "<div>(no image items yet)</div>";
        block.appendChild(emptyLead);
      }

      var list = document.createElement("div");
      list.className = "list";

      if (rest.length){
        rest.forEach(function(a){
          var img2 = pickImage(a);
          var t2 = formatTime(safeTime(a));
          var row = document.createElement("div");
          row.className = "list-row";
          row.innerHTML =
            '<div class="mini">' + (img2 ? '<img loading="lazy" src="' + img2 + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
            '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
            '<div class="time">' + escapeHtml(t2) + '</div>';
          list.appendChild(row);
        });
      } else {
        var noMore = document.createElement("div");
        noMore.className = "list-row";
        noMore.innerHTML = "<div>(no more image items)</div>";
        list.appendChild(noMore);
      }

      block.appendChild(list);
      catGrid.appendChild(block);
    });

    catGridWrap.appendChild(catGrid);
    container.appendChild(catGridWrap);

    // ----- Health & Fitness rail (scrollable) -----
    var health = sortNewestFirst(categories["Health & Fitness"] || []);
    var healthWrap = document.createElement("div");
    healthWrap.innerHTML = sectionHeader("Health & Fitness", "Health & Fitness");

    var healthRail = document.createElement("div");
    healthRail.className = "rail";

    var healthPrefer = health.filter(hasImage).concat(health.filter(function(x){ return !hasImage(x); }));
    var healthItems = take(healthPrefer, 12);

    if (!healthItems.length){
      var hEmpty = document.createElement("div");
      hEmpty.className = "error-box";
      hEmpty.textContent = "(no items yet)";
      healthWrap.appendChild(hEmpty);
    } else {
      healthItems.forEach(function(a){
        var img = pickImage(a);
        var t = formatTime(safeTime(a));
        var card = document.createElement("div");
        card.className = "rail-card";
        card.innerHTML =
          '<div class="thumb">' + (img ? '<img loading="lazy" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
          '<div class="body">' +
            '<p class="title"><a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a></p>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        healthRail.appendChild(card);
      });
      healthWrap.appendChild(healthRail);
    }
    container.appendChild(healthWrap);

    // ----- Entertainment (text-only) -----
    var ent = sortNewestFirst(categories["Entertainment"] || []);
    var entWrap = document.createElement("div");
    entWrap.innerHTML = sectionHeader("Entertainment", "Entertainment");

    var textOnly = document.createElement("div");
    textOnly.className = "text-only";

    var entItems = take(ent, 6);
    if (!entItems.length){
      var eEmpty = document.createElement("div");
      eEmpty.className = "row";
      eEmpty.textContent = "(no items yet)";
      textOnly.appendChild(eEmpty);
    } else {
      entItems.forEach(function(a){
        var t = formatTime(safeTime(a));
        var row = document.createElement("div");
        row.className = "row";
        row.innerHTML =
          '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
          '<div class="meta">' + escapeHtml(t) + '</div>';
        textOnly.appendChild(row);
      });
    }

    entWrap.appendChild(textOnly);
    container.appendChild(entWrap);

    // ----- MORE FOR YOU (infinite scroll, images first) -----
    var shown = {};
    function markShown(arr){
      arr = arr || [];
      for (var i=0;i<arr.length;i++){
        if (arr[i] && arr[i].id) shown[arr[i].id] = true;
      }
    }
    if (heroMain && heroMain.id) shown[heroMain.id] = true;
    markShown(heroSideItems);
    markShown(breakingItems);
    markShown(trendItems);

    blockCats.forEach(function(cat){
      var items = pickTopWithImages(categories[cat] || [], 5);
      markShown(items);
    });

    markShown(healthItems);
    markShown(entItems);

    var candidates = (all || []).filter(function(a){ return a && a.id && !shown[a.id]; });

    var withImg = candidates.filter(hasImage);
    var noImg = candidates.filter(function(x){ return !hasImage(x); });
    moreAll = sortNewestFirst(withImg).concat(sortNewestFirst(noImg));

    var moreWrap = document.createElement("div");
    moreWrap.className = "more-wrap";
    moreWrap.innerHTML = sectionHeader("More for you");

    moreListEl = document.createElement("div");
    moreListEl.className = "more-list";

    moreLoadingEl = document.createElement("div");
    moreLoadingEl.className = "load-hint";
    moreLoadingEl.textContent = "Scroll for more…";

    moreShown = 0;
    moreWrap.appendChild(moreListEl);
    moreWrap.appendChild(moreLoadingEl);
    container.appendChild(moreWrap);

    renderMoreBatch();
    installInfiniteScroll();

    container.querySelectorAll("[data-viewall]").forEach(function(btn){
      btn.addEventListener("click", function(e){
        e.preventDefault();
        var cat = btn.getAttribute("data-viewall");
        showCategoryView(cat);
        // highlight tab on view all
        if (cat) setActiveTab(cat);
      });
    });
  }

  function showCategoryView(category){
    setActiveTab(category);

    var container = document.getElementById("news-container");
    container.innerHTML = "";

    var categories = homepageData.categories || {};
    var items = sortNewestFirst(categories[category] || []);

    var back = document.createElement("a");
    back.href = "#";
    back.className = "back-home";
    back.textContent = "← Back to Home";
    back.addEventListener("click", function(e){
      e.preventDefault();
      renderBBCStyleHome();
    });

    container.appendChild(back);

    var header = document.createElement("div");
    header.innerHTML = sectionHeader(category);
    container.appendChild(header);

    if (!items.length){
      var empty = document.createElement("div");
      empty.className = "error-box";
      empty.textContent = "No articles in this category yet.";
      container.appendChild(empty);
      return;
    }

    var withImg = items.filter(hasImage);
    var noImg = items.filter(function(x){ return !hasImage(x); });
    items = sortNewestFirst(withImg).concat(sortNewestFirst(noImg));

    var list = document.createElement("div");
    list.className = "more-list";

    items.forEach(function(a){
      var img = pickImage(a);
      var t = formatTime(safeTime(a));
      var div = document.createElement("div");
      div.className = "more-item";
      div.innerHTML =
        '<div class="more-thumb">' + (img ? '<img loading="lazy" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
        '<div>' +
          '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
          '<div class="more-meta">' + escapeHtml(t) + '</div>' +
        '</div>';
      list.appendChild(div);
    });

    container.appendChild(list);
  }

  function setActiveTab(cat){
    document.querySelectorAll(".catbtn").forEach(function(btn){
      btn.classList.remove("active");
    });
    var sel = document.querySelector('.catbtn[data-cat="' + cat.replace(/"/g,'\\"') + '"]');
    if (sel) sel.classList.add("active");
  }

  function loadHomepage(){
    var container = document.getElementById("news-container");
    container.innerHTML = "Loading…";

    fetchWithTimeout(API_BASE + "/homepage", 25000)
      .then(function(res){
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function(data){
        homepageData = data;
        if (!homepageData || !homepageData.categories || !homepageData.all){
          showError("Bad JSON structure.");
          return;
        }
        renderBBCStyleHome();
      })
      .catch(function(err){
        console.error(err);
        showError(String(err && err.message ? err.message : err));
      });
  }

  // Category bar click wiring
  document.querySelectorAll(".catbtn").forEach(function(btn){
    btn.addEventListener("click", function(e){
      e.preventDefault();
      if (!homepageData) return;

      var cat = btn.getAttribute("data-cat");
      if (cat === "__home__") {
        renderBBCStyleHome();
      } else {
        showCategoryView(cat);
      }
    });
  });

  loadHomepage();
})();
</script>

</body>
</html>

