<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VIRAL NEWS</title>
<meta name="description" content="Viral News – Latest headlines from all categories">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #0a1d3f;
  color: #fff;
  margin: 0;
  padding: 0;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 20px;
  background: #081737;
  position: sticky;
  top: 0;
  z-index: 1000;
}
header h1 {
  margin: 0;
  font-size: 26px;
  color: #fff;
}
.menu-icon {
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  width: 25px;
  height: 20px;
}
.menu-icon div {
  height: 3px;
  background: #fff;
  border-radius: 2px;
}
#categories-menu {
  position: fixed;
  top: 0;
  left: 0;
  width: 250px;
  height: 100%;
  background: #1a2c5b;
  padding: 20px;
  transform: translateX(-260px);
  transition: transform 0.3s ease;
  overflow-y: auto;
  z-index: 999;
}
#categories-menu.active {
  transform: translateX(0);
}
#categories-menu h2 {
  font-size: 18px;
  margin-bottom: 15px;
}
#categories-menu a {
  display: block;
  text-decoration: none;
  color: #fff;
  padding: 10px 0;
  font-size: 14px;
}
#categories-menu a:hover { color: #ffcc00; }

#news-container {
  max-width: 900px;
  margin: 20px auto;
  padding: 0 20px;
}
.category-section { margin-bottom: 40px; }
.category-section h2 {
  font-size: 20px;
  border-bottom: 2px solid #334a7a;
  padding-bottom: 6px;
  margin-bottom: 15px;
  text-transform: capitalize;
}
.article-item {
  background: #0f264f;
  margin-bottom: 10px;
  padding: 12px;
  border-radius: 8px;
}
.article-item a {
  color: #fff;
  text-decoration: none;
  font-weight: bold;
  display: block;
}
.article-item a:hover { color: #ffcc00; }
.article-time {
  font-size: 12px;
  color: #cfd8ea;
  margin-top: 4px;
}
.error-box {
  background: #331a1a;
  border: 1px solid #ff6b6b;
  padding: 12px;
  border-radius: 8px;
}
.back-home {
  display: inline-block;
  margin: 10px 0 18px;
  font-size: 14px;
  color: #ffcc00;
  cursor: pointer;
}
.small-muted { color: #cfd8ea; font-size: 12px; }
</style>
</head>

<body>

<header>
  <div class="menu-icon" id="menu-toggle" aria-label="Open menu">
    <div></div><div></div><div></div>
  </div>
  <h1>VIRAL NEWS</h1>
</header>

<div id="categories-menu">
  <h2>Categories</h2>
  <a href="#" data-category="breaking">breaking</a>
  <a href="#" data-category="trending">trending</a>
  <a href="#" data-category="top headlines">top headlines</a>
  <a href="#" data-category="General News">General News</a>
  <a href="#" data-category="World News">World News</a>
  <a href="#" data-category="Politics">Politics</a>
  <a href="#" data-category="Technology">Technology</a>
  <a href="#" data-category="Sports">Sports</a>
  <a href="#" data-category="Health & Fitness">Health & Fitness</a>
  <a href="#" data-category="Entertainment">Entertainment</a>
</div>

<div id="news-container">Loading…</div>

<script>
const API_BASE = "https://viral-news-backend-3.onrender.com";

const menuToggle = document.getElementById("menu-toggle");
const categoriesMenu = document.getElementById("categories-menu");
menuToggle.addEventListener("click", () => categoriesMenu.classList.toggle("active"));

document.addEventListener("click", (e) => {
  if (!categoriesMenu.contains(e.target) && !menuToggle.contains(e.target)) {
    categoriesMenu.classList.remove("active");
  }
});

// 14m / 3h / 2d
function formatTime(published_at) {
  const pubDate = new Date(published_at);
  if (isNaN(pubDate.getTime())) return "";
  const diffMs = Date.now() - pubDate.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  if (diffMins < 1) return "now";
  if (diffMins < 60) return `${diffMins}m`;
  const diffHrs = Math.floor(diffMins / 60);
  if (diffHrs < 24) return `${diffHrs}h`;
  const diffDays = Math.floor(diffHrs / 24);
  return `${diffDays}d`;
}

function sanitizeTitle(t) {
  return (t || "").toString().replace(/[\[\]\*\<\>\"\'\`]/g, "").trim();
}

function renderArticleItem(a) {
  const div = document.createElement("div");
  div.className = "article-item";
  div.innerHTML = `
    <a href="articles.html?id=${a.id}">${sanitizeTitle(a.title)}</a>
    <div class="article-time">${formatTime(a.published_at || a.created_at)}</div>
  `;
  return div;
}

let homepageData = null;

async function loadHomepage() {
  const container = document.getElementById("news-container");
  container.innerHTML = "Loading…";

  try {
    const res = await fetch(`${API_BASE}/homepage`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    homepageData = await res.json();

    displayFrontPage();
  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <div class="error-box">
        Failed to load articles from API.<br>
        <span class="small-muted">${String(err)}</span>
      </div>
    `;
  }
}

function displayFrontPage() {
  const container = document.getElementById("news-container");
  container.innerHTML = "";

  const order = (homepageData && homepageData.order) || [];
  const categories = (homepageData && homepageData.categories) || {};
  const all = (homepageData && homepageData.all) || [];

  const shownIds = new Set();

  // Render 10 category sections (top 5 each)
  order.forEach(cat => {
    const section = document.createElement("div");
    section.className = "category-section";
    section.innerHTML = `<h2>${cat}</h2>`;

    const items = (categories[cat] || []).slice(0, 5);

    if (items.length === 0) {
      const empty = document.createElement("div");
      empty.className = "article-item";
      empty.innerHTML = `<div>(no items yet)</div>`;
      section.appendChild(empty);
    } else {
      items.forEach(a => {
        if (a && a.id) shownIds.add(a.id);
        section.appendChild(renderArticleItem(a));
      });
    }

    container.appendChild(section);
  });

  // More for you = anything not in the first 10 buckets top-5 set
  const moreForYou = all.filter(a => a && a.id && !shownIds.has(a.id));

  const moreSection = document.createElement("div");
  moreSection.className = "category-section";
  moreSection.innerHTML = `<h2>More for you</h2>`;

  if (moreForYou.length === 0) {
    const empty = document.createElement("div");
    empty.className = "article-item";
    empty.innerHTML = `<div>No more articles yet.</div>`;
    moreSection.appendChild(empty);
  } else {
    moreForYou.forEach(a => moreSection.appendChild(renderArticleItem(a)));
  }

  container.appendChild(moreSection);
}

function displayCategory(category) {
  const container = document.getElementById("news-container");
  container.innerHTML = "";

  const order = (homepageData && homepageData.order) || [];
  const categories = (homepageData && homepageData.categories) || {};

  // if unknown category, fallback to front page
  if (!order.includes(category)) {
    displayFrontPage();
    return;
  }

  const backBtn = document.createElement("div");
  backBtn.className = "back-home";
  backBtn.textContent = "← Back to Home";
  backBtn.onclick = () => displayFrontPage();
  container.appendChild(backBtn);

  const section = document.createElement("div");
  section.className = "category-section";
  section.innerHTML = `<h2>${category}</h2>`;

  const items = categories[category] || [];
  if (items.length === 0) {
    const empty = document.createElement("div");
    empty.className = "article-item";
    empty.innerHTML = `<div>No articles in this category yet.</div>`;
    section.appendChild(empty);
  } else {
    items.forEach(a => section.appendChild(renderArticleItem(a)));
  }

  container.appendChild(section);
}

document.querySelectorAll("#categories-menu a").forEach(link => {
  link.addEventListener("click", e => {
    e.preventDefault();
    const cat = e.target.dataset.category;
    categoriesMenu.classList.remove("active");
    if (!homepageData) return;
    displayCategory(cat);
  });
});

// Initial load
loadHomepage();
</script>

</body>
</html>
