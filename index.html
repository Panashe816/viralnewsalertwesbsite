<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VIRAL NEWS</title>

<meta name="description" content="Viral News – Latest headlines from all categories" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="canonical" href="https://viralnewsalert.com/" />

<!-- Open Graph -->
<meta property="og:title" content="Viral News" />
<meta property="og:description" content="Latest headlines from all categories." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://viralnewsalert.com/" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Viral News" />
<meta name="twitter:description" content="Latest headlines from all categories." />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#081737">

<style>
  :root{
    --bg:#0a1d3f;
    --bg2:#081737;
    --panel:#0f264f;
    --line:#334a7a;
    --text:#ffffff;
    --muted:#cfd8ea;
    --accent:#ffcc00;
    --danger:#ff6b6b;
    --shadow: 0 10px 24px rgba(0,0,0,.25);
    --radius: 12px;
  }

  *{ box-sizing: border-box; }
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  header{
    background: var(--bg2);
    position: sticky;
    top:0;
    z-index:1000;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }

  .top-row{
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 12px 18px 10px;
    position: relative;
  }
  .brand{
    margin:0;
    font-size: 22px;
    letter-spacing: .7px;
    font-weight: 800;
  }

  /* ✅ Left hamburger */
  .hamburger{
    position:absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 42px;
    height: 38px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.05);
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: 0 6px 16px rgba(0,0,0,.18);
  }
  .hamburger:hover{ border-color: rgba(255,204,0,.35); color: var(--accent); }
  .hamburger:active{ transform: translateY(-50%) scale(.98); }
  .hamburger .bars{
    width: 18px;
    height: 14px;
    position: relative;
  }
  .hamburger .bars span{
    position:absolute;
    left:0;
    right:0;
    height:2px;
    background: currentColor;
    border-radius: 999px;
    opacity:.95;
  }
  .hamburger .bars span:nth-child(1){ top:0; }
  .hamburger .bars span:nth-child(2){ top:6px; }
  .hamburger .bars span:nth-child(3){ top:12px; }

  /* ✅ Dropdown menu (About/Contact/Privacy ONLY) */
  .menu{
    position:absolute;
    left: 10px;
    top: calc(100% + 10px);
    width: 220px;
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    box-shadow: var(--shadow);
    overflow:hidden;
    display:none;
    z-index: 2000;
  }
  .menu a{
    display:flex;
    align-items:center;
    padding: 12px 12px;
    color:#fff;
    text-decoration:none;
    font-weight: 900;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,.07);
  }
  .menu a:last-child{ border-bottom:none; }
  .menu a:hover{
    background: rgba(255,204,0,.10);
    color: var(--accent);
  }

  /* ✅ NEW: Top-right search + refresh (desktop only) */
  .top-actions{
    position:absolute;
    right: 210px; /* sits left of auth-area */
    top: 50%;
    transform: translateY(-50%);
    display:flex;
    align-items:center;
    gap: 10px;
  }
  .top-action-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color:#fff;
    font-size: 13px;
    font-weight: 900;
    cursor:pointer;
    user-select:none;
    white-space: nowrap;
  }
  .top-action-btn:hover{
    border-color: rgba(255,204,0,.35);
    color: var(--accent);
  }

  /* ✅ Top-right auth buttons */
  .auth-area{
    position:absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    display:flex;
    align-items:center;
    gap: 10px;
  }
  .auth-btn{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color:#fff;
    text-decoration:none;
    font-size: 13px;
    font-weight: 900;
    cursor:pointer;
    user-select:none;
    white-space: nowrap;
  }
  .auth-btn:hover{
    border-color: rgba(255,204,0,.35);
    color: var(--accent);
  }
  .auth-btn.primary{
    background: rgba(255,204,0,.14);
    border-color: rgba(255,204,0,.28);
    color: var(--accent);
  }

  /* ✅ Account modal */
  .modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 9999;
  }
  .modal{
    width: 100%;
    max-width: 420px;
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .modal-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 12px 14px;
    background: rgba(255,255,255,.03);
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .modal-title{
    margin:0;
    font-size: 14px;
    font-weight: 900;
    letter-spacing: .3px;
  }
  .modal-close{
    border: none;
    background: transparent;
    color: #fff;
    font-size: 22px;
    cursor: pointer;
    line-height: 1;
    padding: 0 6px;
  }
  .modal-body{
    padding: 14px;
  }
  .field{
    margin-bottom: 10px;
    color: var(--muted);
    font-size: 13px;
  }
  .field strong{
    color:#fff;
  }

  /* ✅ NEW: Mobile bottom tabs (4 buttons) */
  .bottom-tabs{
    position: fixed;
    left:0; right:0; bottom:0;
    height: 58px;
    background: var(--bg2);
    border-top: 1px solid rgba(255,255,255,.12);
    display: none;
    align-items: center;
    justify-content: space-around;
    z-index: 5000;
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .tab-btn{
    flex: 1 1 auto;
    height: 58px;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 12px;
    font-weight: 900;
    cursor: pointer;
  }
  .tab-btn:hover{ color: var(--accent); }
  .tab-btn.active{ color: var(--accent); }

  /* ✅ NEW: Search modal */
  .search-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 9999;
  }
  .search-modal{
    width: 100%;
    max-width: 520px;
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .search-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 12px 14px;
    background: rgba(255,255,255,.03);
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .search-title{
    margin:0;
    font-size: 14px;
    font-weight: 900;
  }
  .search-body{ padding: 14px; }
  .search-input{
    width: 100%;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.06);
    color: #fff;
    font-size: 14px;
    outline: none;
  }
  .search-input:focus{
    border-color: rgba(255,204,0,.35);
  }
  .search-hint{
    margin-top: 10px;
    font-size: 12px;
    color: var(--muted);
  }

  /* ✅ NEW: Settings modal */
  .settings-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 9999;
  }
  .settings-modal{
    width: 100%;
    max-width: 420px;
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .settings-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 12px 14px;
    background: rgba(255,255,255,.03);
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .settings-title{
    margin:0;
    font-size: 14px;
    font-weight: 900;
  }
  .settings-body{ padding: 14px; }
  .settings-links{
    margin-top: 12px;
    display:flex;
    flex-direction: column;
    gap: 10px;
  }
  .settings-links a{
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    color: #fff;
    text-decoration:none;
    font-weight: 900;
    font-size: 13px;
  }
  .settings-links a:hover{
    border-color: rgba(255,204,0,.35);
    color: var(--accent);
  }

  /* keep your existing CSS below unchanged... */

  .catbar{
    display:flex;
    gap: 10px;
    overflow-x: auto;
    padding: 10px 12px 12px;
    border-top: 1px solid rgba(255,255,255,.06);
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  .catbar::-webkit-scrollbar{ height: 8px; }
  .catbar::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.18);
    border-radius: 999px;
  }

  .catbtn{
    scroll-snap-align: start;
    flex: 0 0 auto;
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color:#fff;
    text-decoration:none;
    font-size: 13px;
    font-weight: 800;
    user-select:none;
    white-space: nowrap;
  }
  .catbtn:hover{ border-color: rgba(255,204,0,.35); color: var(--accent); }
  .catbtn.active{
    background: rgba(255,204,0,.16);
    border-color: rgba(255,204,0,.30);
    color: var(--accent);
  }

  #news-container{
    max-width: 1120px;
    margin: 18px auto 70px;
    padding: 0 16px;
  }

  /* ... (ALL your original CSS continues here unchanged in your file) ... */

  @media (max-width: 980px){
    .hero-grid{ grid-template-columns: 1fr; }
    .hero-side{ flex-direction: row; flex-wrap: wrap; }
    .side-item{ grid-template-columns: 70px 1fr; flex: 1 1 280px; }
  }
  @media (max-width: 760px){
    #news-container{ padding: 0 12px; }
    .brand{ font-size: 20px; }
    .auth-area{ right: 10px; }
    .auth-btn{ padding: 7px 10px; font-size: 12px; }

    /* ✅ mobile behavior */
    .top-actions{ display:none; }
    .bottom-tabs{ display:flex; }
    #news-container{ margin-bottom: 86px; } /* space for tabs */
  }
</style>
</head>

<body>

<header>
  <div class="top-row">
    <!-- ✅ Hamburger + dropdown -->
    <button class="hamburger" id="hamburger" type="button" aria-label="Menu" aria-haspopup="true" aria-expanded="false">
      <div class="bars" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
    </button>

    <div class="menu" id="menu">
      <a href="/about-us.html">About Us</a>
      <a href="/contact.html">Contact</a>
      <a href="/privacy-policy.html">Privacy Policy</a>
    </div>
    <h1 class="brand">VIRAL NEWS</h1>

    <!-- ✅ NEW Desktop actions (Search + Refresh) -->
    <div class="top-actions" id="top-actions">
      <button class="top-action-btn" id="btn-search-desktop" type="button">Search</button>
      <button class="top-action-btn" id="btn-refresh-desktop" type="button">Refresh</button>
    </div>

    <!-- ✅ Top-right auth buttons -->
    <div class="auth-area">
      <button class="auth-btn primary" id="btn-signin" type="button">Sign in</button>
      <button class="auth-btn" id="btn-account" type="button" style="display:none;">My Account</button>
    </div>
  </div>

  <nav class="catbar" id="catbar">
    <a class="catbtn active" href="/">Home</a>
    <a class="catbtn" href="/category/breaking.html">Breaking</a>
    <a class="catbtn" href="/category/trending.html">Trending</a>
    <a class="catbtn" href="/category/top-headlines.html">Top Headlines</a>
    <a class="catbtn" href="/category/general.html">General News</a>
    <a class="catbtn" href="/category/world.html">World News</a>
    <a class="catbtn" href="/category/politics.html">Politics</a>
    <a class="catbtn" href="/category/technology.html">Technology</a>
    <a class="catbtn" href="/category/sports.html">Sports</a>
    <a class="catbtn" href="/category/health-fitness.html">Health & Fitness</a>
    <a class="catbtn" href="/category/entertainment.html">Entertainment</a>
  </nav>
</header>

<!-- ✅ My Account modal (email + logout) -->
<div class="modal-overlay" id="account-modal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="account-title">
    <div class="modal-head">
      <h3 class="modal-title" id="account-title">My Account</h3>
      <button class="modal-close" id="account-close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="field">Signed in as: <strong id="account-email">—</strong></div>
      <button class="auth-btn" id="btn-logout" type="button" style="border-color: rgba(255,107,107,.45); color: var(--danger);">
        Logout
      </button>
    </div>
  </div>
</div>

<!-- ✅ NEW Search modal -->
<div class="search-overlay" id="search-overlay">
  <div class="search-modal" role="dialog" aria-modal="true" aria-labelledby="search-title">
    <div class="search-head">
      <h3 class="search-title" id="search-title">Search Headlines</h3>
      <button class="modal-close" id="search-close" aria-label="Close">&times;</button>
    </div>
    <div class="search-body">
      <input class="search-input" id="search-input" type="search" placeholder="Type keywords (e.g. Trump, Bitcoin, Arsenal)..." autocomplete="off" />
      <div class="search-hint">Press Enter to search. Results will show on this page.</div>
    </div>
  </div>
</div>

<!-- ✅ NEW Settings modal -->
<div class="settings-overlay" id="settings-overlay">
  <div class="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="settings-head">
      <h3 class="settings-title" id="settings-title">Settings</h3>
      <button class="modal-close" id="settings-close" aria-label="Close">&times;</button>
    </div>
    <div class="settings-body">
      <div class="field" id="settings-auth-line">—</div>

      <div id="settings-auth-actions" style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="auth-btn primary" id="settings-signin" type="button">Sign in</button>
        <button class="auth-btn" id="settings-account" type="button" style="display:none;">My Account</button>
        <button class="auth-btn" id="settings-logout" type="button" style="display:none; border-color: rgba(255,107,107,.45); color: var(--danger);">Logout</button>
      </div>

      <div class="settings-links">
        <a href="/about-us.html">About Us</a>
        <a href="/contact.html">Contact</a>
        <a href="/privacy-policy.html">Privacy Policy</a>
      </div>
    </div>
  </div>
</div>

<div id="news-container">Loading…</div>

<!-- ✅ NEW Mobile Bottom Tabs (4 buttons) -->
<div class="bottom-tabs" id="bottom-tabs">
  <button class="tab-btn active" id="tab-home" type="button">Home</button>
  <button class="tab-btn" id="tab-refresh" type="button">Refresh</button>
  <button class="tab-btn" id="tab-search" type="button">Search</button>
  <button class="tab-btn" id="tab-settings" type="button">Settings</button>
</div>

<!-- Hidden footer (prevents flash + sitemap never shown) -->
<footer>
  <a href="/about-us.html">About Us</a>
  <a href="/contact.html">Contact</a>
  <a href="/privacy-policy.html">Privacy Policy</a>
  <a href="/sitemap.xml">Sitemap</a>
</footer>

<script>
(function(){
  var API_BASE = "https://viral-news-backend-3.onrender.com";
  var HOMEPAGE_URL = API_BASE + "/homepage";

  var HOME_CACHE_KEY = "vn_homepage_cache_v1";
  var HOME_CACHE_TTL = 60 * 1000;

  // ✅ Auth storage keys
  var ACCESS_KEY = "access_token";
  var USER_EMAIL_KEY = "user_email";

  function escapeHtml(s){
    s = (s || "").toString();
    return s
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function stripHtml(s){
    return (s || "").toString().replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
  }

  function formatTime(dt){
    var d = new Date(dt);
    if (isNaN(d.getTime())) return "";
    var diffMs = Date.now() - d.getTime();
    var mins = Math.floor(diffMs / 60000);
    if (mins < 1) return "now";
    if (mins < 60) return mins + "m";
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + "h";
    var days = Math.floor(hrs / 24);
    return days + "d";
  }

  function safeTime(a){ return a.published_at || a.created_at || ""; }
  function hasImage(a){ return !!((a.image_url || "").trim()); }

  function optimizeImg(url){
    if (!url) return "";
    var u = String(url);
    if (u.indexOf("images.pexels.com") !== -1){
      var hasQ = u.indexOf("?") !== -1;
      return u + (hasQ ? "&" : "?") + "auto=compress&cs=tinysrgb&w=900";
    }
    return u;
  }

  function pickImage(a){
    var img = (a.image_url || "").trim();
    return img ? optimizeImg(img) : null;
  }

  function slugify(s){
    s = (s || "").toString().toLowerCase();
    s = s.replace(/&/g, " and ");
    s = s.replace(/[^a-z0-9]+/g, "-");
    s = s.replace(/-+/g, "-").replace(/^-|-$/g, "");
    return s || "story";
  }

  function linkToArticle(a){
    var cat = slugify(a.category || "general");
    var slug = slugify(a.title || "story");
    return "/news/" + cat + "/" + slug + "-" + encodeURIComponent(a.id) + ".html";
  }

  function viewAllLink(href){
    return '<a class="viewall" href="' + href + '">View all</a>';
  }

  function sectionHeader(title, viewAllHref){
    var viewAll = viewAllHref ? viewAllLink(viewAllHref) : "";
    return '' +
      '<div class="section-title">' +
        '<div class="bar"></div>' +
        '<h2>' + escapeHtml(title) + '</h2>' +
        viewAll +
      '</div>';
  }

  function take(arr, n){ return (arr || []).slice(0, n); }

  function sortNewestFirst(arr){
    arr = (arr || []).slice();
    arr.sort(function(a,b){
      var da = new Date(safeTime(a)).getTime() || 0;
      var db = new Date(safeTime(b)).getTime() || 0;
      return db - da;
    });
    return arr;
  }

  function pickTopWithImages(items, count){
    items = sortNewestFirst(items || []);
    var withImg = [];
    for (var i=0;i<items.length;i++){
      if (hasImage(items[i])) withImg.push(items[i]);
      if (withImg.length >= count) break;
    }
    return withImg;
  }

  function pickFirstWithImage(items){
    items = sortNewestFirst(items || []);
    for (var i=0;i<items.length;i++){
      if (hasImage(items[i])) return items[i];
    }
    return items.length ? items[0] : null;
  }

  function readHomeCache(){
    try{
      var raw = localStorage.getItem(HOME_CACHE_KEY);
      if (!raw) return null;
      var obj = JSON.parse(raw);
      if (!obj || !obj.t || !obj.data) return null;
      if (Date.now() - obj.t > HOME_CACHE_TTL) return null;
      return obj.data;
    }catch(e){
      return null;
    }
  }

  function writeHomeCache(data){
    try{
      localStorage.setItem(HOME_CACHE_KEY, JSON.stringify({ t: Date.now(), data: data }));
    }catch(e){}
  }

  function clearHomeCache(){
    try{ localStorage.removeItem(HOME_CACHE_KEY); }catch(e){}
  }

  function fetchWithTimeout(url, ms){
    return new Promise(function(resolve, reject){
      var timer = setTimeout(function(){
        reject(new Error("Request timed out after " + ms + "ms"));
      }, ms);

      fetch(url, { cache: "default" })
        .then(function(res){ clearTimeout(timer); resolve(res); })
        .catch(function(err){ clearTimeout(timer); reject(err); });
    });
  }

  function fetchJsonWithRetry(url, timeoutMs, retries){
    retries = retries || 0;

    return fetchWithTimeout(url, timeoutMs).then(function(res){
      if (!res.ok){
        if ((res.status === 503 || res.status === 504) && retries < 1){
          return new Promise(function(r){ setTimeout(r, 1200); })
            .then(function(){ return fetchJsonWithRetry(url, timeoutMs, retries + 1); });
        }
        throw new Error("HTTP " + res.status);
      }
      return res.json();
    }).catch(function(err){
      if (retries < 1){
        return new Promise(function(r){ setTimeout(r, 1200); })
          .then(function(){ return fetchJsonWithRetry(url, timeoutMs, retries + 1); });
      }
      throw err;
    });
  }

  function showError(msg){
    var c = document.getElementById("news-container");
    c.innerHTML = '<div class="error-box">Failed to load homepage.<br><span style="color:var(--muted);font-size:12px;">' + escapeHtml(msg) + '</span></div>';
  }

  function isValidHomepage(data){
    return !!(data && data.categories && data.all);
  }

  var homepageData = null;

  // Infinite scroll
  var moreAll = [];
  var moreShown = 0;
  var MORE_BATCH = 12;
  var moreListEl = null;
  var moreLoadingEl = null;
  var loadingMore = false;
  var infiniteInstalled = false;

  function renderMoreBatch(){
    if (!moreListEl || loadingMore) return;
    loadingMore = true;

    var end = Math.min(moreAll.length, moreShown + MORE_BATCH);
    for (var i=moreShown;i<end;i++){
      var a = moreAll[i];
      var img = pickImage(a);
      var t = formatTime(safeTime(a));

      var div = document.createElement("div");
      div.className = "more-item";
      div.innerHTML =
        '<div class="more-thumb">' + (img ? '<img loading="lazy" decoding="async" width="184" height="144" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
        '<div>' +
          '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
          '<div class="more-meta">' + escapeHtml(t) + '</div>' +
        '</div>';

      moreListEl.appendChild(div);
    }

    moreShown = end;

    if (moreShown >= moreAll.length){
      moreLoadingEl.textContent = "No more articles.";
    } else {
      moreLoadingEl.textContent = "Scroll for more…";
    }

    loadingMore = false;
  }

  function installInfiniteScroll(){
    if (infiniteInstalled) return;
    infiniteInstalled = true;

    window.addEventListener("scroll", function(){
      if (!moreListEl) return;
      if (moreShown >= moreAll.length) return;

      var rect = moreListEl.getBoundingClientRect();
      if (rect.bottom <= window.innerHeight + 300){
        renderMoreBatch();
      }
    }, { passive:true });
  }

  function renderHome(){
    var container = document.getElementById("news-container");
    container.innerHTML = "";

    var categories = homepageData.categories || {};
    var all = homepageData.all || [];

    // HERO (Top Headlines)
    var top = categories["top headlines"] || categories["Top Headlines"] || [];
    var heroMain = pickFirstWithImage(top) || pickFirstWithImage(all);

    var heroSideCandidates = top.filter(function(x){ return heroMain ? x.id !== heroMain.id : true; });
    heroSideCandidates = sortNewestFirst(heroSideCandidates);

    var sideWithImg = heroSideCandidates.filter(hasImage);
    var sideNoImg = heroSideCandidates.filter(function(x){ return !hasImage(x); });
    var heroSideItems = take(sideWithImg.concat(sideNoImg), 4);

    var heroWrap = document.createElement("div");
    heroWrap.innerHTML = sectionHeader("Top Headlines", "/category/top-headlines.html");

    var heroGrid = document.createElement("div");
    heroGrid.className = "hero-grid";

    var mainCard = document.createElement("div");
    mainCard.className = "card hero-main";

    var mainImg = heroMain ? pickImage(heroMain) : null;
    var mainTime = heroMain ? formatTime(safeTime(heroMain)) : "";

    // ✅ HERO image: eager + high priority (NOT lazy)
    mainCard.innerHTML =
      '<div class="img">' + (mainImg ? '<img loading="eager" fetchpriority="high" decoding="async" width="1200" height="675" src="' + mainImg + '" alt="' + escapeHtml(heroMain.title) + '">' : '') + '</div>' +
      '<div class="body">' +
        '<div class="kicker">' +
          '<span class="chip">Top</span>' +
          '<span>' + escapeHtml(mainTime) + '</span>' +
        '</div>' +
        '<h3 class="hero-title"><a href="' + (heroMain ? linkToArticle(heroMain) : '#') + '">' + escapeHtml(heroMain ? heroMain.title : 'No headline yet') + '</a></h3>' +
        '<p class="hero-desc">' + escapeHtml(heroMain && heroMain.summary ? stripHtml(heroMain.summary) : '') + '</p>' +
      '</div>';

    var sideCol = document.createElement("div");
    sideCol.className = "hero-side";

    if (!heroSideItems.length){
      var empty = document.createElement("div");
      empty.className = "side-item";
      empty.innerHTML = '<div class="side-thumb"></div><div><p class="side-title">No more headlines yet.</p></div>';
      sideCol.appendChild(empty);
    } else {
      heroSideItems.forEach(function(a){
        var img = pickImage(a);
        var t = formatTime(safeTime(a));
        var div = document.createElement("div");
        div.className = "side-item";
        div.innerHTML =
          '<div class="side-thumb">' + (img ? '<img loading="lazy" decoding="async" width="172" height="128" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
          '<div>' +
            '<p class="side-title"><a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a></p>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        sideCol.appendChild(div);
      });
    }

    heroGrid.appendChild(mainCard);
    heroGrid.appendChild(sideCol);
    heroWrap.appendChild(heroGrid);
    container.appendChild(heroWrap);

    // Breaking strip
    var breaking = sortNewestFirst(categories["breaking"] || categories["Breaking"] || []);
    var breakingBlock = document.createElement("div");
    breakingBlock.innerHTML = sectionHeader("Breaking", "/category/breaking.html");

    var strip = document.createElement("div");
    strip.className = "strip";

    var breakingItems = take(breaking, 6);
    if (!breakingItems.length){
      var bEmpty = document.createElement("div");
      bEmpty.className = "strip-item";
      bEmpty.innerHTML = "<div>(no items yet)</div>";
      strip.appendChild(bEmpty);
    } else {
      breakingItems.forEach(function(a){
        var row = document.createElement("div");
        row.className = "strip-item";
        row.innerHTML =
          '<div style="flex:1">' +
            '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
            '<div class="strip-meta">' + escapeHtml(formatTime(safeTime(a))) + '</div>' +
          '</div>';
        strip.appendChild(row);
      });
    }

    breakingBlock.appendChild(strip);
    container.appendChild(breakingBlock);

    // Trending rail
    var trending = sortNewestFirst(categories["trending"] || categories["Trending"] || []);
    var trendWrap = document.createElement("div");
    trendWrap.innerHTML = sectionHeader("Trending", "/category/trending.html");

    var rail = document.createElement("div");
    rail.className = "rail";

    var trendItems = take(trending, 12);
    if (!trendItems.length){
      var tEmpty = document.createElement("div");
      tEmpty.className = "error-box";
      tEmpty.textContent = "(no items yet)";
      trendWrap.appendChild(tEmpty);
    } else {
      trendItems.forEach(function(a){
        var img = pickImage(a);
        var t = formatTime(safeTime(a));
        var card = document.createElement("div");
        card.className = "rail-card";
        card.innerHTML =
          '<div class="thumb">' + (img ? '<img loading="lazy" decoding="async" width="520" height="300" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
          '<div class="body">' +
            '<p class="title"><a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a></p>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        rail.appendChild(card);
      });
      trendWrap.appendChild(rail);
    }
    container.appendChild(trendWrap);

    // Category blocks
    var blockCats = ["World News","Politics","General News","Technology","Sports"];
    var catGridWrap = document.createElement("div");
    catGridWrap.innerHTML = sectionHeader("Latest by Category");
    var catGrid = document.createElement("div");
    catGrid.className = "cat-grid";

    blockCats.forEach(function(catName){
      var items = sortNewestFirst(categories[catName] || []);
      var withImagesTop5 = pickTopWithImages(items, 5);
      var leadItem = withImagesTop5.length ? withImagesTop5[0] : null;
      var rest = withImagesTop5.length > 1 ? withImagesTop5.slice(1) : [];

      var viewAllHref = "/category/general.html";
      if (catName === "World News") viewAllHref = "/category/world.html";
      if (catName === "Politics") viewAllHref = "/category/politics.html";
      if (catName === "General News") viewAllHref = "/category/general.html";
      if (catName === "Technology") viewAllHref = "/category/technology.html";
      if (catName === "Sports") viewAllHref = "/category/sports.html";

      var block = document.createElement("div");
      block.className = "cat-block";

      var sub = document.createElement("div");
      sub.innerHTML = sectionHeader(catName, viewAllHref);
      block.appendChild(sub);

      if (leadItem){
        var img = pickImage(leadItem);
        var t = formatTime(safeTime(leadItem));
        var lead = document.createElement("div");
        lead.className = "lead";
        lead.innerHTML =
          '<div class="thumb">' + (img ? '<img loading="lazy" decoding="async" width="240" height="168" src="' + img + '" alt="' + escapeHtml(leadItem.title) + '">' : '') + '</div>' +
          '<div>' +
            '<h3><a href="' + linkToArticle(leadItem) + '">' + escapeHtml(leadItem.title) + '</a></h3>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        block.appendChild(lead);
      } else {
        var emptyLead = document.createElement("div");
        emptyLead.className = "lead";
        emptyLead.innerHTML = "<div>(no image items yet)</div>";
        block.appendChild(emptyLead);
      }

      var list = document.createElement("div");
      list.className = "list";

      if (rest.length){
        rest.forEach(function(a){
          var img2 = pickImage(a);
          var t2 = formatTime(safeTime(a));
          var row = document.createElement("div");
          row.className = "list-row";
          row.innerHTML =
            '<div class="mini">' + (img2 ? '<img loading="lazy" decoding="async" width="112" height="84" src="' + img2 + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
            '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
            '<div class="time">' + escapeHtml(t2) + '</div>';
          list.appendChild(row);
        });
      } else {
        var noMore = document.createElement("div");
        noMore.className = "list-row";
        noMore.innerHTML = "<div>(no more image items)</div>";
        list.appendChild(noMore);
      }

      block.appendChild(list);
      catGrid.appendChild(block);
    });

    catGridWrap.appendChild(catGrid);
    container.appendChild(catGridWrap);

    // Health rail
    var health = sortNewestFirst(categories["Health & Fitness"] || []);
    var healthWrap = document.createElement("div");
    healthWrap.innerHTML = sectionHeader("Health & Fitness", "/category/health-fitness.html");

    var healthRail = document.createElement("div");
    healthRail.className = "rail";

    var healthPrefer = health.filter(hasImage).concat(health.filter(function(x){ return !hasImage(x); }));
    var healthItems = take(healthPrefer, 12);

    if (!healthItems.length){
      var hEmpty = document.createElement("div");
      hEmpty.className = "error-box";
      hEmpty.textContent = "(no items yet)";
      healthWrap.appendChild(hEmpty);
    } else {
      healthItems.forEach(function(a){
        var img = pickImage(a);
        var t = formatTime(safeTime(a));
        var card = document.createElement("div");
        card.className = "rail-card";
        card.innerHTML =
          '<div class="thumb">' + (img ? '<img loading="lazy" decoding="async" width="520" height="300" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
          '<div class="body">' +
            '<p class="title"><a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a></p>' +
            '<div class="meta">' + escapeHtml(t) + '</div>' +
          '</div>';
        healthRail.appendChild(card);
      });
      healthWrap.appendChild(healthRail);
    }
    container.appendChild(healthWrap);

    // Entertainment (text)
    var ent = sortNewestFirst(categories["Entertainment"] || []);
    var entWrap = document.createElement("div");
    entWrap.innerHTML = sectionHeader("Entertainment", "/category/entertainment.html");

    var textOnly = document.createElement("div");
    textOnly.className = "text-only";

    var entItems = take(ent, 6);
    if (!entItems.length){
      var eEmpty = document.createElement("div");
      eEmpty.className = "row";
      eEmpty.textContent = "(no items yet)";
      textOnly.appendChild(eEmpty);
    } else {
      entItems.forEach(function(a){
        var t = formatTime(safeTime(a));
        var row = document.createElement("div");
        row.className = "row";
        row.innerHTML =
          '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
          '<div class="meta">' + escapeHtml(t) + '</div>';
        textOnly.appendChild(row);
      });
    }

    entWrap.appendChild(textOnly);
    container.appendChild(entWrap);

    // More for you
    var shown = {};
    function markShown(arr){
      arr = arr || [];
      for (var i=0;i<arr.length;i++){
        if (arr[i] && arr[i].id) shown[arr[i].id] = true;
      }
    }
    if (heroMain && heroMain.id) shown[heroMain.id] = true;
    markShown(heroSideItems);
    markShown(breakingItems);
    markShown(trendItems);

    blockCats.forEach(function(cat){
      var items2 = pickTopWithImages(categories[cat] || [], 5);
      markShown(items2);
    });

    markShown(healthItems);
    markShown(entItems);

    var candidates = (all || []).filter(function(a){ return a && a.id && !shown[a.id]; });

    var withImg = candidates.filter(hasImage);
    var noImg = candidates.filter(function(x){ return !hasImage(x); });
    moreAll = sortNewestFirst(withImg).concat(sortNewestFirst(noImg));

    var moreWrap = document.createElement("div");
    moreWrap.className = "more-wrap";
    moreWrap.innerHTML = sectionHeader("More for you");

    moreListEl = document.createElement("div");
    moreListEl.className = "more-list";

    moreLoadingEl = document.createElement("div");
    moreLoadingEl.className = "load-hint";
    moreLoadingEl.textContent = "Scroll for more…";

    moreShown = 0;
    moreWrap.appendChild(moreListEl);
    moreWrap.appendChild(moreLoadingEl);
    container.appendChild(moreWrap);

    renderMoreBatch();
    installInfiniteScroll();
  }

  function loadHomepage(force){
    var container = document.getElementById("news-container");

    if (force){
      clearHomeCache();
      container.innerHTML = "Loading…";
    }

    // 1) show cache instantly
    var cached = (!force) ? readHomeCache() : null;
    if (cached && isValidHomepage(cached)){
      homepageData = cached;
      renderHome();
    } else if (!force){
      container.innerHTML = "Loading…";
    }

    // 2) background refresh
    fetchJsonWithRetry(HOMEPAGE_URL, 20000, 0)
      .then(function(data){
        if (!isValidHomepage(data)){
          if (!cached) showError("Bad JSON structure.");
          return;
        }
        homepageData = data;
        writeHomeCache(data);
        renderHome();
      })
      .catch(function(err){
        console.error(err);
        if (!cached) showError(String(err && err.message ? err.message : err));
      });
  }

  // ✅ Search rendering (client-side over homepageData.all)
  function renderSearchResults(q){
    var container = document.getElementById("news-container");
    if (!homepageData || !homepageData.all){
      container.innerHTML = '<div class="error-box">Search not ready yet. Please refresh and try again.</div>';
      return;
    }

    var term = (q || "").toLowerCase().trim();
    if (!term){
      container.innerHTML = '<div class="error-box">Type something to search.</div>';
      return;
    }

    var all = homepageData.all || [];
    var matches = all.filter(function(a){
      var t = (a.title || "").toLowerCase();
      var s = stripHtml(a.summary || "").toLowerCase();
      return t.indexOf(term) !== -1 || s.indexOf(term) !== -1;
    });

    container.innerHTML = "";
    var head = document.createElement("div");
    head.innerHTML = sectionHeader('Search: "' + escapeHtml(q) + '"');
    container.appendChild(head);

    if (!matches.length){
      var empty = document.createElement("div");
      empty.className = "error-box";
      empty.textContent = "No results found.";
      container.appendChild(empty);
      return;
    }

    var list = document.createElement("div");
    list.className = "more-list";

    matches.slice(0, 60).forEach(function(a){
      var img = pickImage(a);
      var t = formatTime(safeTime(a));
      var div = document.createElement("div");
      div.className = "more-item";
      div.innerHTML =
        '<div class="more-thumb">' + (img ? '<img loading="lazy" decoding="async" width="184" height="144" src="' + img + '" alt="' + escapeHtml(a.title) + '">' : '') + '</div>' +
        '<div>' +
          '<a href="' + linkToArticle(a) + '">' + escapeHtml(a.title) + '</a>' +
          '<div class="more-meta">' + escapeHtml(t) + '</div>' +
        '</div>';
      list.appendChild(div);
    });

    container.appendChild(list);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ✅ Minimal auth UI behavior (ONLY Sign in + My Account + email + logout)
  function getToken(){
    try { return localStorage.getItem(ACCESS_KEY) || ""; } catch(e){ return ""; }
  }
  function isLoggedIn(){
    return !!getToken();
  }
  function setLoggedOut(){
    try{
      localStorage.removeItem(ACCESS_KEY);
      localStorage.removeItem(USER_EMAIL_KEY);
    }catch(e){}
    refreshAuthUI();
    refreshSettingsUI();
  }
  function refreshAuthUI(){
    var btnSignin = document.getElementById("btn-signin");
    var btnAccount = document.getElementById("btn-account");
    var emailEl = document.getElementById("account-email");

    var logged = isLoggedIn();
    if (btnSignin) btnSignin.style.display = logged ? "none" : "inline-flex";
    if (btnAccount) btnAccount.style.display = logged ? "inline-flex" : "none";

    var email = "";
    try { email = localStorage.getItem(USER_EMAIL_KEY) || ""; } catch(e){}
    if (!email) email = "(email not set yet)";
    if (emailEl) emailEl.textContent = email;
  }

  function openAccountModal(){
    var overlay = document.getElementById("account-modal");
    if (overlay) overlay.style.display = "flex";
  }
  function closeAccountModal(){
    var overlay = document.getElementById("account-modal");
    if (overlay) overlay.style.display = "none";
  }

  function setupAuthUI(){
    var btnSignin = document.getElementById("btn-signin");
    var btnAccount = document.getElementById("btn-account");
    var btnLogout = document.getElementById("btn-logout");
    var btnClose = document.getElementById("account-close");
    var overlay = document.getElementById("account-modal");

    if (btnSignin){
      btnSignin.addEventListener("click", function(){
        window.location.href = "/login.html";
      });
    }

    if (btnAccount){
      btnAccount.addEventListener("click", function(){
        refreshAuthUI();
        openAccountModal();
      });
    }

    if (btnLogout){
      btnLogout.addEventListener("click", function(){
        setLoggedOut();
        closeAccountModal();
      });
    }

    if (btnClose) btnClose.addEventListener("click", closeAccountModal);

    if (overlay){
      overlay.addEventListener("click", function(e){
        if (e.target === overlay) closeAccountModal();
      });
    }

    window.addEventListener("keydown", function(e){
      if (e.key === "Escape") closeAccountModal();
    });

    refreshAuthUI();
  }

  // ✅ Hamburger dropdown logic
  function setupMenu(){
    var burger = document.getElementById("hamburger");
    var menu = document.getElementById("menu");

    function closeMenu(){
      if (!menu || !burger) return;
      menu.style.display = "none";
      burger.setAttribute("aria-expanded", "false");
    }
    function toggleMenu(){
      if (!menu || !burger) return;
      var open = (menu.style.display === "block");
      if (open){
        closeMenu();
      } else {
        menu.style.display = "block";
        burger.setAttribute("aria-expanded", "true");
      }
    }

    if (burger) burger.addEventListener("click", function(e){
      e.stopPropagation();
      toggleMenu();
    });

    document.addEventListener("click", function(){
      closeMenu();
    });

    if (menu) menu.addEventListener("click", function(e){
      e.stopPropagation();
    });

    window.addEventListener("keydown", function(e){
      if (e.key === "Escape") closeMenu();
    });
  }

  // ✅ Search modal open/close
  function openSearch(){
    var ov = document.getElementById("search-overlay");
    var inp = document.getElementById("search-input");
    if (ov) ov.style.display = "flex";
    setTimeout(function(){
      if (inp){ inp.focus(); inp.select(); }
    }, 50);
  }
  function closeSearch(){
    var ov = document.getElementById("search-overlay");
    if (ov) ov.style.display = "none";
  }

  // ✅ Settings modal open/close
  function openSettings(){
    var ov = document.getElementById("settings-overlay");
    if (ov) ov.style.display = "flex";
    refreshSettingsUI();
  }
  function closeSettings(){
    var ov = document.getElementById("settings-overlay");
    if (ov) ov.style.display = "none";
  }

  function refreshSettingsUI(){
    var line = document.getElementById("settings-auth-line");
    var sSignin = document.getElementById("settings-signin");
    var sAccount = document.getElementById("settings-account");
    var sLogout = document.getElementById("settings-logout");

    var logged = isLoggedIn();
    var email = "";
    try{ email = localStorage.getItem(USER_EMAIL_KEY) || ""; }catch(e){}
    if (!email) email = "(email not set yet)";

    if (line){
      line.innerHTML = logged
        ? ('Signed in as: <strong>' + escapeHtml(email) + '</strong>')
        : ('You are not signed in.');
    }

    if (sSignin) sSignin.style.display = logged ? "none" : "inline-flex";
    if (sAccount) sAccount.style.display = logged ? "inline-flex" : "none";
    if (sLogout) sLogout.style.display = logged ? "inline-flex" : "none";
  }

  function setupSearchAndSettings(){
    var btnSearchDesktop = document.getElementById("btn-search-desktop");
    var btnRefreshDesktop = document.getElementById("btn-refresh-desktop");

    var searchClose = document.getElementById("search-close");
    var searchOverlay = document.getElementById("search-overlay");
    var searchInput = document.getElementById("search-input");

    var settingsClose = document.getElementById("settings-close");
    var settingsOverlay = document.getElementById("settings-overlay");

    // desktop buttons
    if (btnSearchDesktop) btnSearchDesktop.addEventListener("click", openSearch);
    if (btnRefreshDesktop) btnRefreshDesktop.addEventListener("click", function(){
      loadHomepage(true);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // search close
    if (searchClose) searchClose.addEventListener("click", closeSearch);
    if (searchOverlay){
      searchOverlay.addEventListener("click", function(e){
        if (e.target === searchOverlay) closeSearch();
      });
    }

    // search enter
    if (searchInput){
      searchInput.addEventListener("keydown", function(e){
        if (e.key === "Enter"){
          closeSearch();
          renderSearchResults(searchInput.value);
        }
      });
    }

    // settings close
    if (settingsClose) settingsClose.addEventListener("click", closeSettings);
    if (settingsOverlay){
      settingsOverlay.addEventListener("click", function(e){
        if (e.target === settingsOverlay) closeSettings();
      });
    }

    // settings actions
    var sSignin = document.getElementById("settings-signin");
    var sAccount = document.getElementById("settings-account");
    var sLogout = document.getElementById("settings-logout");

    if (sSignin){
      sSignin.addEventListener("click", function(){
        window.location.href = "/login.html";
      });
    }
    if (sAccount){
      sAccount.addEventListener("click", function(){
        closeSettings();
        refreshAuthUI();
        openAccountModal();
      });
    }
    if (sLogout){
      sLogout.addEventListener("click", function(){
        setLoggedOut();
        closeSettings();
      });
    }
  }

  // ✅ Mobile bottom tabs wiring (4 buttons)
  function setupBottomTabs(){
    var home = document.getElementById("tab-home");
    var refresh = document.getElementById("tab-refresh");
    var search = document.getElementById("tab-search");
    var settings = document.getElementById("tab-settings");

    function setActive(id){
      var ids = ["tab-home","tab-refresh","tab-search","tab-settings"];
      ids.forEach(function(x){
        var el = document.getElementById(x);
        if (el) el.classList.toggle("active", x === id);
      });
    }

    if (home) home.addEventListener("click", function(){
      setActive("tab-home");
      if (homepageData) renderHome();
      else loadHomepage(false);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    if (refresh) refresh.addEventListener("click", function(){
      setActive("tab-refresh");
      loadHomepage(true);
      window.scrollTo({ top: 0, behavior: "smooth" });
      setTimeout(function(){ setActive("tab-home"); }, 400);
    });

    if (search) search.addEventListener("click", function(){
      setActive("tab-search");
      openSearch();
      setTimeout(function(){ setActive("tab-home"); }, 200);
    });

    if (settings) settings.addEventListener("click", function(){
      setActive("tab-settings");
      openSettings();
      setTimeout(function(){ setActive("tab-home"); }, 200);
    });
  }

  setupMenu();
  setupAuthUI();
  setupSearchAndSettings();
  setupBottomTabs();
  loadHomepage(false);
})();
</script>

<!-- Ads at bottom so content paints first -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5368831813847678"
     crossorigin="anonymous"></script>

</body>
</html>
